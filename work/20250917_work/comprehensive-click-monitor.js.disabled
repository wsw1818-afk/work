/**
 * í¬ê´„ì  í´ë¦­ ì´ë²¤íŠ¸ ëª¨ë‹ˆí„°ë§ ë° ì§„ë‹¨ ì‹œìŠ¤í…œ
 * ëª¨ë“  í´ë¦­ ì´ë²¤íŠ¸ê°€ ì°¨ë‹¨ë˜ëŠ” ì›ì¸ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ì¶”ì í•˜ê³  í•´ê²°
 */

(function() {
    'use strict';

    console.log('ğŸ” í¬ê´„ì  í´ë¦­ ì´ë²¤íŠ¸ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ ì‹œì‘');

    // í™”ë©´ì— ì‹¤ì‹œê°„ ì§„ë‹¨ ì°½ ìƒì„±
    let diagnosticPanel = null;
    let clickLog = [];

    function createDiagnosticPanel() {
        if (diagnosticPanel) return;

        diagnosticPanel = document.createElement('div');
        diagnosticPanel.id = 'clickDiagnosticPanel';
        diagnosticPanel.style.cssText = `
            position: fixed;
            top: 10px;
            right: 10px;
            width: 400px;
            height: 300px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            border: 2px solid #00ff00;
            border-radius: 8px;
            z-index: 999999;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 10px;
            overflow-y: auto;
        `;

        const header = document.createElement('div');
        header.innerHTML = `
            <strong>ğŸ” í´ë¦­ ì´ë²¤íŠ¸ ì§„ë‹¨ê¸°</strong>
            <button onclick="this.parentElement.parentElement.remove()"
                    style="float:right; background:red; color:white; border:none; padding:2px 8px; cursor:pointer;">âœ•</button>
            <hr style="margin: 5px 0;">
        `;

        const logContainer = document.createElement('div');
        logContainer.id = 'clickLogContainer';
        logContainer.style.cssText = `
            height: 250px;
            overflow-y: auto;
            font-size: 11px;
            line-height: 1.3;
        `;

        diagnosticPanel.appendChild(header);
        diagnosticPanel.appendChild(logContainer);
        document.body.appendChild(diagnosticPanel);

        console.log('âœ… ì§„ë‹¨ íŒ¨ë„ ìƒì„± ì™„ë£Œ');
    }

    function addLogEntry(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const colors = {
            info: '#00ff00',
            warn: '#ffff00',
            error: '#ff0000',
            success: '#00ffff'
        };

        clickLog.push({ timestamp, message, type });

        const logContainer = document.getElementById('clickLogContainer');
        if (logContainer) {
            const entry = document.createElement('div');
            entry.style.color = colors[type] || '#00ff00';
            entry.innerHTML = `[${timestamp}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;

            // ë¡œê·¸ê°€ ë„ˆë¬´ ë§ì•„ì§€ë©´ ì˜¤ë˜ëœ í•­ëª© ì œê±°
            if (logContainer.children.length > 100) {
                logContainer.removeChild(logContainer.firstChild);
            }
        }

        console.log(`[í´ë¦­ì§„ë‹¨] ${message}`);
    }

    // ëª¨ë“  DOM ìš”ì†Œì— ëŒ€í•´ í´ë¦­ ì´ë²¤íŠ¸ ê°ì§€
    function setupGlobalClickMonitoring() {
        // ìµœìƒìœ„ ë ˆë²¨ì—ì„œ ëª¨ë“  í´ë¦­ ì´ë²¤íŠ¸ ìºì¹˜
        document.addEventListener('click', function(e) {
            const target = e.target;
            const tagName = target.tagName;
            const id = target.id;
            const className = target.className;
            const text = target.textContent ? target.textContent.substring(0, 50) : '';

            addLogEntry(`âœ… CLICK: ${tagName}${id ? '#' + id : ''}${className ? '.' + className : ''} "${text}"`, 'success');
        }, true); // capture phase

        // í´ë¦­ ì´ë²¤íŠ¸ê°€ ì°¨ë‹¨ë˜ëŠ” ê²½ìš° ê°ì§€
        document.addEventListener('click', function(e) {
            addLogEntry(`âš ï¸ í´ë¦­ ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë‹¨ê³„ ë„ë‹¬`, 'warn');
        }, false); // bubble phase

        // mousedown, mouseupë„ ëª¨ë‹ˆí„°ë§
        document.addEventListener('mousedown', function(e) {
            addLogEntry(`ğŸ–±ï¸ MOUSEDOWN: ${e.target.tagName} (${e.button})`, 'info');
        }, true);

        document.addEventListener('mouseup', function(e) {
            addLogEntry(`ğŸ–±ï¸ MOUSEUP: ${e.target.tagName} (${e.button})`, 'info');
        }, true);
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì°¨ë‹¨ ê°ì§€
    function detectEventBlocking() {
        const originalAddEventListener = EventTarget.prototype.addEventListener;
        const originalRemoveEventListener = EventTarget.prototype.removeEventListener;

        EventTarget.prototype.addEventListener = function(type, listener, options) {
            if (type === 'click') {
                addLogEntry(`ğŸ“ í´ë¦­ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€: ${this.tagName || this.constructor.name}`, 'info');
            }
            return originalAddEventListener.call(this, type, listener, options);
        };

        EventTarget.prototype.removeEventListener = function(type, listener, options) {
            if (type === 'click') {
                addLogEntry(`ğŸ—‘ï¸ í´ë¦­ ë¦¬ìŠ¤ë„ˆ ì œê±°: ${this.tagName || this.constructor.name}`, 'warn');
            }
            return originalRemoveEventListener.call(this, type, listener, options);
        };
    }

    // preventDefault í˜¸ì¶œ ê°ì§€
    function detectPreventDefault() {
        const originalPreventDefault = Event.prototype.preventDefault;
        Event.prototype.preventDefault = function() {
            if (this.type === 'click') {
                addLogEntry(`ğŸš« preventDefault í˜¸ì¶œë¨: ${this.target.tagName}`, 'error');

                // í˜¸ì¶œ ìŠ¤íƒ ì¶”ì 
                try {
                    throw new Error();
                } catch (e) {
                    addLogEntry(`ğŸ“ í˜¸ì¶œìœ„ì¹˜: ${e.stack.split('\n')[2]}`, 'error');
                }
            }
            return originalPreventDefault.call(this);
        };
    }

    // stopPropagation í˜¸ì¶œ ê°ì§€
    function detectStopPropagation() {
        const originalStopPropagation = Event.prototype.stopPropagation;
        Event.prototype.stopPropagation = function() {
            if (this.type === 'click') {
                addLogEntry(`â›” stopPropagation í˜¸ì¶œë¨: ${this.target.tagName}`, 'error');
            }
            return originalStopPropagation.call(this);
        };
    }

    // CSS pointer-events ê²€ì‚¬
    function checkPointerEvents() {
        const elements = document.querySelectorAll('*');
        let blockedCount = 0;

        elements.forEach(el => {
            const style = window.getComputedStyle(el);
            if (style.pointerEvents === 'none') {
                blockedCount++;
                if (el.id || el.className) {
                    addLogEntry(`ğŸš« CSS pointer-events:none ë°œê²¬: ${el.tagName}${el.id ? '#' + el.id : ''}${el.className ? '.' + el.className : ''}`, 'warn');
                }
            }
        });

        if (blockedCount > 0) {
            addLogEntry(`âš ï¸ ì´ ${blockedCount}ê°œ ìš”ì†Œì—ì„œ pointer-events:none ë°œê²¬`, 'warn');
        }
    }

    // ì˜¤ë²„ë ˆì´ ìš”ì†Œ ê²€ì‚¬
    function checkOverlayElements() {
        const highZIndexElements = [];
        const elements = document.querySelectorAll('*');

        elements.forEach(el => {
            const style = window.getComputedStyle(el);
            const zIndex = parseInt(style.zIndex);

            if (zIndex > 1000) {
                const rect = el.getBoundingClientRect();
                if (rect.width > 0 && rect.height > 0) {
                    highZIndexElements.push({
                        element: el,
                        zIndex: zIndex,
                        rect: rect
                    });
                }
            }
        });

        if (highZIndexElements.length > 0) {
            addLogEntry(`ğŸ” ë†’ì€ z-index ìš”ì†Œ ${highZIndexElements.length}ê°œ ë°œê²¬`, 'warn');
            highZIndexElements.forEach(item => {
                addLogEntry(`  - ${item.element.tagName} z-index:${item.zIndex} (${item.rect.width}x${item.rect.height})`, 'warn');
            });
        }
    }

    // íŠ¹ì • ë²„íŠ¼ë“¤ ê°œë³„ í…ŒìŠ¤íŠ¸
    function testSpecificButtons() {
        // ì„¤ì • ë²„íŠ¼ í…ŒìŠ¤íŠ¸
        const settingsBtn = document.getElementById('settingsBtn');
        if (settingsBtn) {
            addLogEntry(`ğŸ¯ ì„¤ì • ë²„íŠ¼ ë°œê²¬: display=${getComputedStyle(settingsBtn).display}, pointer-events=${getComputedStyle(settingsBtn).pointerEvents}`, 'info');

            // ì¸ê³µ í´ë¦­ í…ŒìŠ¤íŠ¸
            try {
                const event = new MouseEvent('click', {
                    bubbles: true,
                    cancelable: true
                });
                settingsBtn.dispatchEvent(event);
                addLogEntry(`ğŸ§ª ì„¤ì • ë²„íŠ¼ ì¸ê³µ í´ë¦­ í…ŒìŠ¤íŠ¸ ì™„ë£Œ`, 'success');
            } catch (error) {
                addLogEntry(`âŒ ì„¤ì • ë²„íŠ¼ ì¸ê³µ í´ë¦­ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // ë‹¬ë ¥ ë‚ ì§œ í´ë¦­ í…ŒìŠ¤íŠ¸
        const dayElements = document.querySelectorAll('.day');
        if (dayElements.length > 0) {
            addLogEntry(`ğŸ“… ë‹¬ë ¥ ë‚ ì§œ ìš”ì†Œ ${dayElements.length}ê°œ ë°œê²¬`, 'info');

            const firstDay = dayElements[0];
            const style = getComputedStyle(firstDay);
            addLogEntry(`  ì²« ë²ˆì§¸ ë‚ ì§œ: display=${style.display}, pointer-events=${style.pointerEvents}, cursor=${style.cursor}`, 'info');
        }
    }

    // ì£¼ê¸°ì  ì§„ë‹¨ ì‹¤í–‰
    function runPeriodicDiagnostics() {
        addLogEntry(`ğŸ”„ ì •ê¸° ì§„ë‹¨ ì‹¤í–‰ ì¤‘...`, 'info');
        checkPointerEvents();
        checkOverlayElements();
        testSpecificButtons();
    }

    // ì´ˆê¸°í™” í•¨ìˆ˜
    function initialize() {
        addLogEntry(`ğŸš€ í´ë¦­ ì§„ë‹¨ ì‹œìŠ¤í…œ ì´ˆê¸°í™”`, 'success');

        createDiagnosticPanel();
        setupGlobalClickMonitoring();
        detectEventBlocking();
        detectPreventDefault();
        detectStopPropagation();

        // ì´ˆê¸° ì§„ë‹¨ ì‹¤í–‰
        setTimeout(() => {
            runPeriodicDiagnostics();
        }, 1000);

        // 5ì´ˆë§ˆë‹¤ ì •ê¸° ì§„ë‹¨
        setInterval(runPeriodicDiagnostics, 5000);

        addLogEntry(`âœ… ëª¨ë“  ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ í™œì„±í™”`, 'success');
        addLogEntry(`ğŸ“ ì´ì œ ë§ˆìš°ìŠ¤ë¡œ í´ë¦­í•´ë³´ì„¸ìš”!`, 'info');
    }

    // ì „ì—­ í•¨ìˆ˜ë¡œ ìˆ˜ë™ ì§„ë‹¨ ì‹¤í–‰ ê°€ëŠ¥í•˜ê²Œ
    window.runClickDiagnostics = runPeriodicDiagnostics;
    window.clearClickLog = function() {
        clickLog = [];
        const logContainer = document.getElementById('clickLogContainer');
        if (logContainer) {
            logContainer.innerHTML = '';
        }
        addLogEntry(`ğŸ§¹ ë¡œê·¸ ì´ˆê¸°í™”ë¨`, 'info');
    };

    // DOM ë¡œë“œ ì™„ë£Œ í›„ ì´ˆê¸°í™”
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initialize);
    } else {
        initialize();
    }

    console.log('âœ… í¬ê´„ì  í´ë¦­ ì´ë²¤íŠ¸ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ ë¡œë“œ ì™„ë£Œ');
    console.log('ğŸ› ï¸ ì‚¬ìš©ë²•: runClickDiagnostics() - ìˆ˜ë™ ì§„ë‹¨, clearClickLog() - ë¡œê·¸ ì´ˆê¸°í™”');
})();