/**
 * ê¸´ê¸‰ ë¬´í•œë£¨í”„ í‚¬ëŸ¬ - CPU ê³¼ë¶€í•˜ í•´ê²°
 * ëª¨ë“  íƒ€ì´ë¨¸ì™€ ë£¨í”„ë¥¼ ê°•ì œ ì¤‘ë‹¨
 */

(function() {
    'use strict';

    console.log('ğŸš¨ ê¸´ê¸‰ ë¬´í•œë£¨í”„ í‚¬ëŸ¬ ì‹œì‘ - CPU ê³¼ë¶€í•˜ í•´ê²°');

    // ëª¨ë“  íƒ€ì´ë¨¸ ID ì¶”ì 
    let timerIds = [];
    let intervalIds = [];

    // ëª¨ë“  setTimeout ê°•ì œ ì •ë¦¬
    function killAllTimeouts() {
        console.log('ğŸ”ª ëª¨ë“  setTimeout ê°•ì œ ì •ë¦¬ ì‹œì‘');

        // ê°€ëŠ¥í•œ ëª¨ë“  timeout IDë¥¼ ì‹œë„ (0ë¶€í„° 10000ê¹Œì§€)
        for (let i = 0; i < 10000; i++) {
            try {
                clearTimeout(i);
            } catch (e) {
                // ë¬´ì‹œ
            }
        }

        console.log('âœ… setTimeout ì •ë¦¬ ì™„ë£Œ');
    }

    // ëª¨ë“  setInterval ê°•ì œ ì •ë¦¬
    function killAllIntervals() {
        console.log('ğŸ”ª ëª¨ë“  setInterval ê°•ì œ ì •ë¦¬ ì‹œì‘');

        // ê°€ëŠ¥í•œ ëª¨ë“  interval IDë¥¼ ì‹œë„ (0ë¶€í„° 10000ê¹Œì§€)
        for (let i = 0; i < 10000; i++) {
            try {
                clearInterval(i);
            } catch (e) {
                // ë¬´ì‹œ
            }
        }

        console.log('âœ… setInterval ì •ë¦¬ ì™„ë£Œ');
    }

    // requestAnimationFrame ì •ë¦¬
    function killAllAnimationFrames() {
        console.log('ğŸ”ª ëª¨ë“  requestAnimationFrame ê°•ì œ ì •ë¦¬ ì‹œì‘');

        for (let i = 0; i < 1000; i++) {
            try {
                cancelAnimationFrame(i);
            } catch (e) {
                // ë¬´ì‹œ
            }
        }

        console.log('âœ… requestAnimationFrame ì •ë¦¬ ì™„ë£Œ');
    }

    // ëª¨ë“  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° (ê³¼ë„í•œ ì´ë²¤íŠ¸ ë£¨í”„ ë°©ì§€)
    function killExcessiveEventListeners() {
        console.log('ğŸ”ª ê³¼ë„í•œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì •ë¦¬ ì‹œì‘');

        // ëª¨ë“  ìš”ì†Œì—ì„œ ê³¼ë„í•œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
        const elements = document.querySelectorAll('*');
        elements.forEach(element => {
            // ìƒˆë¡œìš´ ìš”ì†Œë¡œ êµì²´í•˜ì—¬ ëª¨ë“  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
            if (element.id && element.id !== 'clickDiagnosticPanel') {
                try {
                    const newElement = element.cloneNode(true);
                    element.parentNode.replaceChild(newElement, element);
                } catch (e) {
                    // ë¬´ì‹œ
                }
            }
        });

        console.log('âœ… ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì •ë¦¬ ì™„ë£Œ');
    }

    // íƒ€ì´ë¨¸ ìƒì„± ë°©ì§€
    function preventNewTimers() {
        console.log('ğŸ›¡ï¸ ìƒˆë¡œìš´ íƒ€ì´ë¨¸ ìƒì„± ë°©ì§€ ì‹œì‘');

        const originalSetTimeout = window.setTimeout;
        const originalSetInterval = window.setInterval;

        window.setTimeout = function(callback, delay) {
            console.warn('âš ï¸ setTimeout í˜¸ì¶œ ì°¨ë‹¨ë¨');
            return -1; // ë¬´íš¨í•œ íƒ€ì´ë¨¸ ID ë°˜í™˜
        };

        window.setInterval = function(callback, delay) {
            console.warn('âš ï¸ setInterval í˜¸ì¶œ ì°¨ë‹¨ë¨');
            return -1; // ë¬´íš¨í•œ íƒ€ì´ë¨¸ ID ë°˜í™˜
        };

        // 5ì´ˆ í›„ ì •ìƒ ë³µêµ¬ (ì‘ê¸‰ìƒí™© í•´ê²° í›„)
        setTimeout(() => {
            window.setTimeout = originalSetTimeout;
            window.setInterval = originalSetInterval;
            console.log('âœ… íƒ€ì´ë¨¸ í•¨ìˆ˜ ì •ìƒ ë³µêµ¬');
        }, 5000);

        console.log('âœ… íƒ€ì´ë¨¸ ìƒì„± ë°©ì§€ ì™„ë£Œ');
    }

    // ëª¨ë“  ìŠ¤í¬ë¦½íŠ¸ì˜ while/for ë£¨í”„ ê°ì§€ ë° ì¤‘ë‹¨ (ê°€ëŠ¥í•œ ë²”ìœ„ì—ì„œ)
    function killCPUHogs() {
        console.log('ğŸ”ª CPU ì§‘ì•½ì  ì‘ì—… ì¤‘ë‹¨ ì‹œì‘');

        // ë†’ì€ CPU ì‚¬ìš©ë¥ ì„ ìœ ë°œí•  ìˆ˜ ìˆëŠ” ì „ì—­ ë³€ìˆ˜ë“¤ ì´ˆê¸°í™”
        const suspiciousGlobals = [
            'isProcessing',
            'isLooping',
            'isRunning',
            'continuousUpdate',
            'autoRefresh'
        ];

        suspiciousGlobals.forEach(varName => {
            if (window[varName]) {
                window[varName] = false;
                console.log(`ğŸ›‘ ì „ì—­ ë³€ìˆ˜ ${varName} = falseë¡œ ì„¤ì •`);
            }
        });

        console.log('âœ… CPU ì§‘ì•½ì  ì‘ì—… ì¤‘ë‹¨ ì™„ë£Œ');
    }

    // ì¦‰ì‹œ ëª¨ë“  ê¸´ê¸‰ ì¡°ì¹˜ ì‹¤í–‰
    function emergencyKill() {
        console.log('ğŸš¨ ê¸´ê¸‰ ì‹œìŠ¤í…œ ì •ë¦¬ ì‹œì‘');

        try {
            killAllTimeouts();
            killAllIntervals();
            killAllAnimationFrames();
            killCPUHogs();
            preventNewTimers();

            // DOM ì¡°ì‘ ìµœì†Œí™”
            document.body.style.pointerEvents = 'auto';
            document.body.style.overflow = 'auto';

            console.log('ğŸ‰ ê¸´ê¸‰ ì‹œìŠ¤í…œ ì •ë¦¬ ì™„ë£Œ - CPU ì‚¬ìš©ë¥ ì´ ì •ìƒí™”ë˜ì–´ì•¼ í•©ë‹ˆë‹¤');

        } catch (error) {
            console.error('âŒ ê¸´ê¸‰ ì •ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
        }
    }

    // ì¦‰ì‹œ ì‹¤í–‰
    emergencyKill();

    // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡í•˜ì—¬ ì½˜ì†”ì—ì„œ ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
    window.emergencyKill = emergencyKill;
    window.killAllTimers = function() {
        killAllTimeouts();
        killAllIntervals();
        killAllAnimationFrames();
    };

    console.log('âœ… ê¸´ê¸‰ ë¬´í•œë£¨í”„ í‚¬ëŸ¬ ë¡œë“œ ì™„ë£Œ');
    console.log('ğŸ› ï¸ ìˆ˜ë™ ì‹¤í–‰: emergencyKill() ë˜ëŠ” killAllTimers()');
})();