# AGENTS.md — 초보자 친화형 코딩 에이전트 지침서 (for Codex)

> 이 문서는 **내 입력이 짧거나 모호해도** Codex가 일관된 품질로 작업하도록 하는 규칙입니다.  
> 아래 규칙은 **항상 우선 적용**합니다.

---

## 0) 기본 원칙
- **초보자 우선**: 어려운 용어는 풀어서 설명하고, 단계별로 안내합니다.
- **질문 후 진행**: 정보가 부족하면 **최대 3개의 짧은 확인 질문**만 하고, 합리적 가정을 명시하여 진행합니다.
- **작게, 안전하게**: 한 번에 **하나의 기능/파일** 중심으로 최소 변경을 제안합니다.
- **증거 기반**: 모든 변경은 **테스트/린트/타입체크 로그**로 검증합니다.
- **보안 우선**: 비밀정보/네트워크/의존성 추가는 보수적으로 다룹니다.

---

## 1) 출력 형식(반드시 이 순서/제목으로 답변)
1. **SUMMARY** — 사용자가 이해할 수 있게 3~5줄로 요약  
2. **PLAN** — 체크리스트(최소 단계로)  
3. **PATCH** — **통합 diff(unified diff)**. 파일 경로를 꼭 표시하고, 필요한 부분만 최소 수정  
4. **COMMANDS_RAN** — 실행한 명령어 목록  
5. **RESULTS** — 각 명령의 결과(성공/실패 로그 요약 + 핵심 에러 원문)  
6. **CHECKS** — 린트/타입/테스트/보안/성능/접근성 점검 요약  
7. **NEXT_STEPS** — 사용자가 바로 할 수 있는 다음 행동 3가지  

---

## 2) 작업 흐름
1. **계획**: 변경 파일, 영향, 테스트 항목을 PLAN에 체크리스트로  
2. **패치**: 전체 재작성 금지. PATCH는 최소 diff  
3. **검증 실행**: *명령어 매핑*에 따라 실행하고 RESULTS에 로그 기록  
   - **테스트 루프**: `테스트 실행 → 실패 로그 인용 → 최소 수정(PATCH) → 재실행`을 **최대 3회** 반복  
   - **종료 조건**: 테스트/린트/타입체크 **모두 통과**해야 완료로 간주  
   - **flaky 완화**: 시드 고정, 타임아웃 상향, 단일 테스트 격리 후 재시도(1회)  
   - **시간 보고**: 총 테스트 실행 시간을 **RESULTS**에 초 단위로 기입  
4. **자체 점검**: CHECKS에 품질/보안/성능/접근성 결과 기입  
5. **안내**: NEXT_STEPS에 초보자도 따라 할 수 있는 3단계 안내

---

## 3) 명령어 매핑(스택 감지)
### JavaScript/TypeScript
- 설치: `pnpm install` | `yarn` | `npm install`  
- 개발: `pnpm dev` | `yarn dev` | `npm run dev`  
- 빌드: `pnpm build` | `yarn build` | `npm run build`  
- 테스트: `pnpm test` | `yarn test` | `npm test`  
  - Vitest: `pnpm vitest run` / Jest: `pnpm jest --runInBand`  
  - 단일 케이스: `pnpm vitest run -t "<name>"` / `pnpm jest -t "<name>"`  
- 타입체크: `pnpm typecheck` 또는 `tsc -p .`  
- 린트: `pnpm lint` 또는 `eslint .`

### Python
- 설치: `pip install -r requirements.txt`  
- 테스트: `pytest -q`  (단일: `pytest -q -k "<expr>"`)  
- 린트/포맷: `ruff check .` / `ruff format .`  
- 타입체크: `pyright` 또는 `mypy`

---

## 4) 작업 범위와 금지
- **허용**: `src/`, `app/`, `pages/`, `components/`, `lib/`, `tests/`, `locales/`, `docs/`  
- **변경 금지**: `infra/`, `db/migrations/`, `*secrets*` (승인 필요)  
- **의존성 추가**: 1~2개 소규모만 승인 후 진행  
- **네트워크 호출**: 기본 차단, 필요 시 PLAN에 목적/엔드포인트 명시 후 승인

---

## 5) 코드 스타일 & 구조
- Prettier/ESLint/Ruff/Black 규칙 준수  
- 의미 있는 변수/함수 이름  
- **왜** 필요한지 간단히 주석  
- UI: 접근성 속성(`aria-*`, alt) 필수  
- i18n 문자열은 `locales/`에 저장  
- 로그는 비밀정보 제거 후 최소화

---

## 6) 테스트 정책
- **TDD 지향**: 가능하면 테스트 먼저 제시  
- 단위 + 통합 테스트 최소 1개  
- 테스트가 없으면 샘플 테스트 추가 제안  
- 예: "검색어 book 입력 → 3건 200ms 내 표시"

### 6.1 자동 테스트/수정 루프(에이전트 규칙)
- 모든 작업은 완료 전에 **전체 테스트**를 실행한다.  
- 실패 시 **최소 수정**으로 원인 구간만 고치고 **재실행**한다(최대 3회).  
- 실패 로그는 **원문 일부를 인용**하고, **환경 변수/시간·랜덤/네트워크 의존** 여부를 점검한다.  
- **Flaky**로 판단되면: 시드 고정(`--seed`), 타임아웃 상향, 테스트 격리/리트라이를 제안하고 근본 원인을 기록.  
- 성능 기준(§20) 내에서 **테스트 총 소요 시간**을 RESULTS에 수치로 보고한다.

---

## 7) 보안/개인정보/라이선스
- 비밀키/토큰은 코드에 포함 금지 → `.env` 사용  
- 외부 패키지: 유지관리 상태/라이선스 확인 후 최소 추가  
- 개인정보 로그는 반드시 마스킹  

---

## 8) 성능/접근성/SEO(웹 시)
- 성능: 불필요한 렌더 방지, 이미지 최적화  
- 접근성: 키보드 탐색, 레이블/대체 텍스트  
- SEO: 메타 태그, 의미론적 마크업  

---

## 9) 사전 승인 필요
- 프레임워크 교체/대규모 구조 변경  
- 3개 이상 의존성 추가 또는 메이저 업그레이드  
- DB 스키마/마이그레이션 변경  
- 장기 실행/외부 네트워크 의존 작업

---

## 10) Clarification 트리거
- 목표 불명확  
- API/데이터 구조 모호  
- 성능/보안 제약 불확실  

→ 이 경우 최대 3문장으로 질문 후 진행

---

## 11) 오류 대응
- 실패 로그 원문 포함  
- 원인 가설 → 최소 수정안 → 재검증 계획  
- 같은 실패 2회 이상 시 대체 전략 제시  

---

## 12) 커밋/PR 규칙
- 커밋 1건 = 1기능/1버그  
- 제목: `[scope] 요약` (예: `[todos] 검색 기능 추가`)  
- 본문: 배경 → 변경점 → 검증(로그/테스트) → 영향/리스크  

---

## 13) 미니 템플릿(입력 짧을 때)
<goal>한 줄 목표</goal>
<context>관련 파일/폴더</context>
<acceptance>
- 성공 기준 2~3개
</acceptance>

---

## 14) 디폴트 가정
- 프론트엔드: React/Next.js + TypeScript  
- 백엔드: REST + JSON  
- 로케일: ko-KR  

---

## 15) 품질 체크리스트
- [ ] 린트/포맷 통과  
- [ ] 타입체크 통과  
- [ ] 단위/통합 테스트 통과  
- [ ] 보안 점검 완료  
- [ ] 성능 기준(§20) 검토 + 접근성(A11y) 고려  
- [ ] 변경점 문서화

---

## 16) AI 도구 활용 정책
- GitHub Copilot / Claude / ChatGPT 등 **AI 제안 코드는 반드시 리뷰 후 채택**합니다.
- 생성된 코드는 **테스트·린트·타입체크 통과** 여부를 RESULTS에 로그로 증명합니다.
- **라이선스/보안 위험**(무단 복제, 취약한 샘플 코드, 하드코딩된 비밀키, `eval` 남용 등) 금지.
- 출처가 모호한 코드 스니펫은 **대체 구현**을 우선 검토합니다.

---

## 17) 명령어 매핑 확장(감지 우선순위)
1. **`package.json`의 `scripts` 우선**: `dev / build / test / lint / typecheck`가 정의돼 있으면 이를 사용.
2. **락파일로 패키지 매니저 결정**: `pnpm-lock.yaml` > `yarn.lock` > `package-lock.json`.
3. **없으면 기본값 제안 후 승인**:
   - JS/TS 기본: `npm run build`, `npm test`, `eslint .`, `tsc -p .`(또는 `pnpm/yarn` 동등 명령)
   - Python 기본: `pytest -q`, `ruff check .`, `ruff format .`, `pyright | mypy`
4. scripts가 비어 있으면, **PLAN에 추가 스크립트 초안**을 제안하고 승인 후 `package.json`에 반영합니다.

---

## 18) 에러 대응 매뉴얼
**공통 규칙**: 실패 로그는 **원문 인용**하고, **원인 가설 → 최소 수정안 → 재검증 계획** 순서로 보고합니다.

- **Network/Permission**
  - 체크: 자격증명(.env), 권한/토큰, 방화벽·프록시, 엔드포인트/HTTP 메서드, CORS(웹)
  - 조치: 재시도(지수 백오프), 타임아웃·에러 핸들링 강화, 민감정보 마스킹 로그
- **Build 실패**
  - 체크: Node/패키지 버전, 락파일 불일치, 중복/순환 의존
  - 조치: 버전 고정, 충돌 패키지 교체, **`pnpm install --frozen-lockfile`**(또는 동등 옵션) 재설치
- **Test 실패**
  - 체크: 환경변수 누락, Mock/Fixture, 시간·랜덤 의존성, 비정상 입력 케이스
  - 조치: 테스트 격리/시드 고정, 경계값 추가, 타임아웃 조정

---

## 19) 팀 협업 정책
- **브랜치 명명**: `feature/<설명>`, `fix/<설명>`, `chore/<설명>`, `refactor/<설명>`
- **코드 리뷰 가이드라인**
  - 우선순위: **정확성 → 보안 → 성능 → 가독성/유지보수성**
  - PR은 **배경 → 변경점 → 검증(로그/스크린샷) → 영향/리스크**를 간단명료하게
  - **불필요한 포맷 변경/대량 이동 금지**(diff 최소화)
- **PR 셀프 체크리스트**
  - [ ] 린트·타입·테스트 통과
  - [ ] 보안(비밀값/로그/의존성) 점검
  - [ ] **성능 기준(§20) 검토** 및 수치 보고
  - [ ] 문서/주석/변경점 요약 포함
  - [ ] 수용 기준(acceptance) 충족 증거 첨부

---

## 20) 성능 기준(경고/리뷰 트리거)
> 초기 성공 빌드에서 **baseline**을 기록하고(PR마다 전/후 비교) 필요시 조정합니다.

- **빌드 시간**: `< 30초` 권고 / `30~60초` 경고 / `> 60초` 리뷰
- **번들 크기**: baseline 대비 `+10%` 초과 시 리뷰( `+25%` 강경 경고 )
- **테스트 전체 실행 시간**: `< 5초` 권고 / `5~15초` 경고 / `> 15초` 리뷰
- 운영 팁:
  - 최초 기준을 `docs/perf-baseline.md`(또는 JSON)로 저장: `{{ buildTime, bundleKB, testTime }}`
  - PR에서는 **RESULTS에 전/후 수치 표**로 보고
  - 필요 시 `size-limit`/번들 분석기 등 **devDependency** 도입 제안(설치 전 승인)

---

## 21) Codex 전용 — 자동 테스트 실행 & 수정 루프
> Codex가 이 문서의 지침을 따를 때 적용되는 “마무리 체크 규칙”입니다.

### 21.1 실행 원칙
- Codex는 이 문서의 **테스트/타입/린트 명령**을 근거로 작업 종료 전 **프로그램적 체크를 실행**하고, 실패 시 **수정 후 재실행**을 시도한다.  
- **Auto 승인 모드**에서는 워킹 디렉터리 내부의 **파일 읽기/수정/명령 실행**이 자동이며, **네트워크/외부 경로 접근은 승인**이 필요하다.  
- 결과는 답변의 **RESULTS**와 **CHECKS** 섹션에 요약한다.

### 21.2 비대화형(스크립팅) 실행 예시
```bash
# 프로젝트 테스트를 돌리고, 실패 시 수정 후 재실행하여 모두 통과할 때까지 시도
codex exec "Run the project's test suite as defined in AGENTS.md. If any tests fail, diagnose and fix them with minimal changes, then re-run until all tests pass. Summarize changes."
```

### 21.3 실패 대응 빠른 체크
- 환경변수/시계·랜덤/외부 API 의존 여부를 먼저 점검  
- 타임아웃·리트라이·격리로 flaky 완화 후 **근본 원인 수정** 우선

---

> 문서 버전: v1.3 — 마지막 업데이트: 2025-09-25
